<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secuenciador de Tiempos | Rodrigo Pizarro</title>
  <!-- Fuentes y hoja de estilos global existente -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="stylesheet" href="style.css" />

  <!-- Ajustes mínimos específicos del temporizador -->
  <style>
    :root {
      /* Colores para contadores */
      --color-work-phase: var(--color-chinese-seal-red);
      --color-rest-phase: #22c55e; /* verde suave consistente con modo claro y oscuro */
    }

    /* Tabla temporizador */
    #timer-table th {
      font-family: var(--font-title);
      font-weight: 600;
      color: var(--color-text-title);
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--color-border-subtle);
    }
    #timer-table td {
      padding: 0.5rem 0.25rem;
      text-align: center;
      vertical-align: middle;
    }
    .countdown.work {
      color: var(--color-work-phase);
    }
    .countdown.rest {
      color: var(--color-rest-phase);
    }

    /* Parpadeo a −10 s */
    @keyframes blinkBorder {
      0%, 100% { box-shadow: 0 0 0 0 var(--color-text-light); }
      50% { box-shadow: 0 0 0 3px var(--color-text-light); }
    }
    .warning {
      animation: blinkBorder 0.9s step-start infinite;
    }

    /* Botones secundarios (gris) – variante sutil para acompañar .button-manuscript */
    .btn-secondary {
      border: 2px solid var(--color-border-subtle);
      color: var(--color-text-main);
      background: var(--color-bg-section);
      padding: 0.65rem 1.25rem;
      font-family: var(--font-body);
      font-weight: 500;
    }
    .btn-icon {
      padding: 0.4rem 0.6rem;
      border: 1px solid var(--color-border-input);
      background: transparent;
    }
  </style>
</head>
<body class="rice-paper-bg">
  <a href="#main-content" class="skip-link">Saltar al contenido</a>

  <!-- Puede incluirse header/nav global mediante include si tu sistema de templates lo soporta -->

  <main id="main-content" class="container mx-auto px-6 py-16 md:py-24 fade-in">
    <h1 class="font-title text-3xl md:text-4xl text-title-ink mb-8 text-center">Secuenciador de Tiempos</h1>

    <div class="card-manuscript p-6 md:p-10 shadow-lg">
      <!-- Controles globales -->
      <div class="flex flex-col md:flex-row items-center gap-4 mb-8">
        <label class="flex items-center gap-2">
          <span class="font-medium">Repetir secuencia</span>
          <input id="globalRepeat" type="number" min="1" value="1" class="w-20" />
        </label>

        <div class="ml-auto flex gap-4">
          <button id="addRow" class="btn-secondary">Añadir fila</button>
          <button id="startBtn" class="button-manuscript">Start</button>
          <button id="stopBtn" class="btn-secondary">Stop</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table id="timer-table" class="w-full text-sm">
          <thead>
            <tr>
              <th>Acción</th>
              <th>Repetir</th>
              <th>Trabajo (seg)</th>
              <th>×</th>
              <th>Cuenta trabajo</th>
              <th>Descanso (seg)</th>
              <th>×</th>
              <th>Cuenta descanso</th>
              <th>Eliminar</th>
            </tr>
          </thead>
          <tbody id="timerBody"></tbody>
        </table>
      </div>

      <!-- Sonidos personalizados -->
      <div class="grid md:grid-cols-2 gap-4 mt-8">
        <label class="flex items-center gap-2">
          <span class="font-medium">Sonido trabajo</span>
          <input id="soundWork" type="file" accept="audio/*" />
        </label>
        <label class="flex items-center gap-2">
          <span class="font-medium">Sonido descanso</span>
          <input id="soundRest" type="file" accept="audio/*" />
        </label>
      </div>
    </div>
  </main>

  <script>
    const timerBody = document.getElementById('timerBody');
    const addRowBtn = document.getElementById('addRow');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const globalRepeatInput = document.getElementById('globalRepeat');
    const soundWorkInput = document.getElementById('soundWork');
    const soundRestInput = document.getElementById('soundRest');

    let sequence = [];
    let currentIndex = 0;
    let intervalId = null;
    let phase = 'work';
    let remaining = 0;
    let repeatCycle = 1;

    function createAudio(url) {
      const audio = new Audio(url);
      audio.preload = 'auto';
      return audio;
    }
    let audioWork = null;
    let audioRest = null;

    function beep(freq = 880) {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.frequency.value = freq;
      osc.type = 'sine';
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      gain.gain.setValueAtTime(0.25, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.4);
      osc.stop(ctx.currentTime + 0.4);
    }

    function addRow() {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" placeholder="Acción"></td>
        <td><input type="number" class="w-20" min="1" value="1"></td>
        <td><input type="number" class="step10 w-24" step="10" min="0" value="60"></td>
        <td><input type="number" class="w-20" min="1" value="1"></td>
        <td class="countdown work">—</td>
        <td><input type="number" class="step10 w-24" step="10" min="0" value="30"></td>
        <td><input type="number" class="w-20" min="1" value="1"></td>
        <td class="countdown rest">—</td>
        <td><button class="btn-icon deleteRow" aria-label="Eliminar fila"><i class="fas fa-trash-alt"></i></button></td>`;
      timerBody.appendChild(tr);
      tr.querySelector('.deleteRow').addEventListener('click', () => {
        if (intervalId && tr.dataset.active === 'true') return;
        tr.remove();
      });
    }

    addRowBtn.addEventListener('click', addRow);
    addRow();

    startBtn.addEventListener('click', () => {
      if (intervalId) return;
      buildSequence();
      repeatCycle = parseInt(globalRepeatInput.value, 10) || 1;
      audioWork = soundWorkInput.files[0] ? createAudio(URL.createObjectURL(soundWorkInput.files[0])) : null;
      audioRest = soundRestInput.files[0] ? createAudio(URL.createObjectURL(soundRestInput.files[0])) : null;
      currentIndex = 0;
      runNextPhase();
      toggleInputs(true);
    });

    stopBtn.addEventListener('click', () => resetAll());

    function buildSequence() {
      sequence = [];
      [...timerBody.children].forEach(row => {
        const action = row.children[0].firstElementChild.value || 'Acción';
        const repeat = parseInt(row.children[1].firstElementChild.value, 10) || 1;
        const work = parseInt(row.children[2].firstElementChild.value, 10) || 0;
        const multWork = parseInt(row.children[3].firstElementChild.value, 10) || 1;
        const rest = parseInt(row.children[5].firstElementChild.value, 10) || 0;
        const multRest = parseInt(row.children[6].firstElementChild.value, 10) || 1;
        for (let r = 0; r < repeat; r++) {
          sequence.push({ action, work: work * multWork, rest: rest * multRest });
        }
      });
    }

    function runNextPhase() {
      if (currentIndex >= sequence.length) {
        repeatCycle--;
        if (repeatCycle > 0) {
          currentIndex = 0;
        } else {
          resetAll(true);
          return;
        }
      }
      const item = sequence[currentIndex];
      phase = 'work';
      remaining = item.work;
      updateUI();
      intervalId = setInterval(tick, 1000);
    }

    function tick() {
      remaining--;
      updateUI();
      if (remaining <= 0) {
        if (phase === 'work') {
          if (audioWork) audioWork.play(); else beep();
          phase = 'rest';
          remaining = sequence[currentIndex].rest;
          updateUI();
        } else {
          if (audioRest) audioRest.play(); else beep(660);
          sequence[currentIndex].done = true;
          currentIndex++;
          phase = 'work';
          clearInterval(intervalId);
          intervalId = null;
          runNextPhase();
        }
      }
    }

    function updateUI() {
      const rows = [...timerBody.children];
      rows.forEach((row, idx) => {
        const cdWork = row.children[4];
        const cdRest = row.children[7];
        if (idx === currentIndex) {
          row.dataset.active = 'true';
          cdWork.textContent = phase === 'work' ? remaining : (sequence[idx].work === 0 ? '—' : 'FINALIZADO');
          cdRest.textContent = phase === 'rest' ? remaining : (sequence[idx].rest === 0 ? '—' : (sequence[idx].done ? 'FINALIZADO' : '—'));
          const targetCell = phase === 'work' ? cdWork : cdRest;
          if (remaining <= 10 && remaining > 0) targetCell.classList.add('warning');
          else targetCell.classList.remove('warning');
        } else {
          row.dataset.active = 'false';
          if (sequence[idx] && sequence[idx].done) {
            cdWork.textContent = 'FINALIZADO';
            cdRest.textContent = sequence[idx].rest ? 'FINALIZADO' : '—';
          }
        }
      });
    }

    function toggleInputs(disabled) {
      [...document.querySelectorAll('#timer-table input')].forEach(el => el.disabled = disabled);
      addRowBtn.disabled = disabled;
      startBtn.disabled = disabled;
    }

    function resetAll(finished = false) {
      if (intervalId) { clearInterval(intervalId); intervalId = null; }
      sequence = [];
      currentIndex = 0;
      [...timerBody.children].forEach(row => {
        row.children[4].textContent = '—';
        row.children[7].textContent = '—';
        row.children[4].classList.remove('warning');
        row.children[7].classList.remove('warning');
      });
      toggleInputs(false);
      if (finished) {
        // Aquí podrías disparar una notificación global o mensaje modal
      }
    }
  </script>
</body>
</html>
